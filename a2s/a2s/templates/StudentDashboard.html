
{% extends "student_base.html" %}
{% load static %}

{% block title %}A2S Student Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/StudentDashboard.css' %}" />
{% endblock %}

{% block content %}

<!-- Welcome Section -->
<div class="welcome-card">
  <div class="welcome-content">
    <div class="welcome-text">
      <h2>Welcome back, {{ student.first_name }}</h2>
      <p>{{ current_semester }} • {{ active_courses_count }} active courses</p>
    </div>
    <div class="welcome-gpa">
      <div class="gpa-value">{{ student.gpa }}</div>
      <div class="gpa-label">Current GPA</div>
    </div>
  </div>
</div>


<!-- Dashboard Tabs -->
<div class="tabs">
  <div class="tab-list">
    <button class="tab-trigger active" data-tab="dashboard">Overview</button>
    <button class="tab-trigger" data-tab="calendar">Academic Calendar</button>
    <button class="tab-trigger" data-tab="curriculum">Curriculum</button>
    <button class="tab-trigger" data-tab="grades">Progress"</button>
  </div>

  <!-- Dashboard Tab -->
  <div class="tab-content active" id="dashboard">
    <div class="quick-actions-grid">
      <div class="action-card"><i data-lucide="calendar"></i><h3>Schedule</h3><p>View timetable</p></div>
      <div class="action-card"><i data-lucide="file-text"></i><h3>View Grades</h3><p>Check your scores</p></div>
      <div class="action-card"><i data-lucide="trending-up"></i><h3>Degree Audit</h3><p>Track your progress</p></div>
      <div class="action-card"><i data-lucide="trophy"></i><h3>Achievements</h3><p>Check your achievements</p></div>
    </div>

    <div class="cards-row">
      <!-- Current Courses Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Current Courses</div>
          <div class="card-description">Fall 2025 • 4 enrolled courses</div>
        </div>
        <div class="card-content">
          <div class="course-list">
            <div class="course-item"><div class="course-details"><div class="course-code">IT317</div><div class="course-name">Systems Integration</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
            <div class="course-item"><div class="course-details"><div class="course-code">CSIT327</div><div class="course-name">Database Systems</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
            <div class="course-item"><div class="course-details"><div class="course-code">IT315</div><div class="course-name">Web Development</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
            <div class="course-item"><div class="course-details"><div class="course-code">CSIT340</div><div class="course-name">Industry Elective 2</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
          </div>
        </div>
      </div>

      <!-- Recent Notifications Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Notifications</div>
          <div class="card-description">Important updates for you</div>
        </div>
        <div class="card-content">
          <div class="task-list">
            <div class="task-item"><div class="task-details"><div class="task-title">Assignment 3 Deadline</div><div class="task-due">Due: Oct 5, 2025</div></div><div class="task-type">Urgent</div></div>
            <div class="task-item"><div class="task-details"><div class="task-title">Midterm Exam Schedule</div><div class="task-due">Starts: Nov 10, 2025</div></div><div class="task-type">Exam</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="tab-content" id="curriculum">
  <div class="card curriculum-card">
    <div class="card-header curriculum-header">
      <div>
        <div class="card-title">Curriculum</div>
      </div>

      <div class="curriculum-controls">
        <select id="yearSelect" class="year-dropdown">
          <option value="All">All Years</option>
          <option value="First Year">1st Year</option>
          <option value="Second Year">2nd Year</option>
          <option value="Third Year">3rd Year</option>
          <option value="Fourth Year">4th Year</option>
        </select>

        <div class="curriculum-buttons">
          <button class="filter-btn active" data-filter="All">All</button>
          <button class="filter-btn" data-filter="PASSED">Completed</button>
          <button class="filter-btn" data-filter="CURRENT">Current</button>
          <button class="filter-btn" data-filter="RECOMMENDED">Recommended</button>
        </div>
      </div>
    </div>

    <div class="card-content curriculum-content">
      <div id="curriculum-container" class="curriculum-table">
        <p>Loading curriculum data...</p>
        <p>Program: {{ student.program }}</p>

      </div>
    </div>
  </div>
</div>



<!-- Event Modal -->
<div id="eventModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="eventName"></h3>
    <p><strong>Type:</strong> <span id="eventType"></span></p>
    <p><strong>Date:</strong> <span id="eventDate"></span></p>
  </div>
</div>



  

  <div class="tab-content" id="grades">
    <div class="card">
      <div class="card-header"><div class="card-title">Grades</div><div class="card-description">View your scores and feedback</div></div>
      <div class="card-content"><p>Grades overview UI placeholder.</p></div>
    </div>
  </div>

 <!-- Calendar Tab -->
<div class="tab-content" id="calendar">
  <div class="calendar-controls">
  <label for="calendarSemesterSelect">Semester:</label>
  <select id="calendarSemesterSelect"></select>

  <label for="calendarYearSelect">Year:</label>
  <select id="calendarYearSelect"></select>
</div>

  <div class="calendar-container">
    <h2 id="month-title"></h2>
    <div class="calendar-nav">
      <button id="prev-month">&lt; Prev</button>
      <button id="next-month">Next &gt;</button>
    </div>
    <div id="calendar-grid"></div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  lucide.createIcons(); // Initialize Lucide icons

  // -------------------- Tabs --------------------
  const tabTriggers = document.querySelectorAll('.tab-trigger');
  const tabContents = document.querySelectorAll('.tab-content');
  tabTriggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const target = trigger.dataset.tab;
      tabTriggers.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      trigger.classList.add('active');
      document.getElementById(target).classList.add('active');
    });
  });

  // -------------------- Curriculum --------------------
  const container = document.getElementById("curriculum-container");
  let allData = [];

    try {
    allData = JSON.parse('{{ curriculum_json|escapejs }}') || [];
  } catch(e) {
    console.error("Error parsing curriculum JSON:", e);
    container.innerHTML = `<p style="color:red;">Error loading curriculum data.</p>`;
  }

  const studentProgram = "{{ student_program }}"; 

  if (!studentProgram || studentProgram === "Undeclared") {
    container.innerHTML = `<p style="color:red;">Program not set for this student.</p>`;
  } else {
    renderCurriculum(allData);
  }

  fetch(`/api/curriculum/${studentProgram}/`)
    .then(response => {
      if (!response.ok) throw new Error("Curriculum not found for " + studentProgram);
      return response.json();
    })
    .then(data => {
      allData = data.curriculum || [];
      renderCurriculum(allData);
    })
    .catch(err => {
      container.innerHTML = `<p style="color:red;">Error loading curriculum: ${err.message}</p>`;
      console.error(err);
    });

  // -------------------- Render Function --------------------
  function renderCurriculum(curriculum) {
    container.innerHTML = "";

    if (!curriculum.length) {
      container.innerHTML = "<p>No curriculum data available for this program.</p>";
      return;
    }

    curriculum.forEach(year => {
      const yearBlock = document.createElement("div");
      yearBlock.classList.add("year-block");
      yearBlock.innerHTML = `<h3>${year.year}</h3>`;

      year.terms.forEach(term => {
        const table = document.createElement("table");

        const header = `
          <thead>
            <tr>
              <th>Term</th>
              <th>Subject Code</th>
              <th>Description</th>
              <th>Units</th>
              <th>School Year</th>
              <th>Semester</th>
              <th>Status</th>
            </tr>
          </thead>
        `;

        const rows = term.subjects.map(subj => `
          <tr data-status="${subj.final_grade}">
            <td>${term.term}</td>
            <td>${subj.subject_code}</td>
            <td>${subj.description}</td>
            <td>${subj.units}</td>
            <td>${subj.school_year}</td>
            <td>${subj.semester}</td>
            <td>${subj.final_grade}</td>
          </tr>
        `).join("");

        table.innerHTML = header + `<tbody>${rows}</tbody>`;
        yearBlock.appendChild(table);
      });

      container.appendChild(yearBlock);
    });
  }

  // -------------------- Filters --------------------
  const yearSelect = document.getElementById("yearSelect");
  const buttons = document.querySelectorAll(".filter-btn");

function filterCurriculum() {
  const selectedYear = yearSelect.value;
  const activeBtn = document.querySelector(".filter-btn.active");
  const selectedStatus = activeBtn ? activeBtn.dataset.filter.toUpperCase() : "ALL";

  let filtered = allData;

  // Filter by year
  if (selectedYear !== "All") {
    filtered = filtered.filter(y => y.year.toLowerCase() === selectedYear.toLowerCase());
  }

  // Filter by status
  if (selectedStatus !== "ALL") {
    filtered = filtered.map(year => ({
      ...year,
      terms: year.terms.map(term => ({
        ...term,
        subjects: term.subjects.filter(s => {
          return (s.final_grade || "").toUpperCase() === selectedStatus;
        })
      })).filter(term => term.subjects.length > 0)
    })).filter(year => year.terms.length > 0);
  }

  renderCurriculum(filtered);
}

  yearSelect.addEventListener("change", filterCurriculum);
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      filterCurriculum();
    });
  });

  // -------------------- Calendar --------------------

  

  const calendarGrid = document.getElementById("calendar-grid");
  const monthTitle = document.getElementById("month-title");
  const prevBtn = document.getElementById("prev-month");
  const nextBtn = document.getElementById("next-month");
  const calendarYearSelect = document.getElementById("calendarYearSelect");
  const calendarSemesterSelect = document.getElementById("calendarSemesterSelect");

  let currentDate = new Date();
  let currentYear = currentDate.getFullYear();
  let currentMonth = currentDate.getMonth();
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  // -------------------- Load Calendar Data --------------------
  let calendarData = [];
try {
    calendarData = JSON.parse('{{ calendar_json|escapejs }}');  // parse JSON string
    if (!Array.isArray(calendarData)) {
        console.error("Calendar JSON is not an array:", calendarData);
        calendarData = [];
    }
} catch (e) {
    console.error("Error parsing calendar JSON:", e);
}
console.log("calendarData:", calendarData);  // debug

  if (!Array.isArray(calendarData)) {
    console.error("Calendar data is not an array:", calendarData);
    calendarData = [];
  }

  // Flatten events
  let allEvents = [];
  calendarData.forEach(sem => {
    sem.events.forEach(ev => {
      allEvents.push({
        date: new Date(ev.date),
        name: ev.name,
        type: ev.type,
        semester: sem.semester
      });
    });
  });

  const eventColors = {
    "Holiday": "#ffcccc",
    "Class Start": "#cce5ff",
    "Class End": "#d4edda",
    "Exam": "#fff3cd",
    "Deadline": "#f8d7da",
    "Ceremony": "#e2e3e5",
    "Special Non-Working Day": "#f0b3ff"
  };

  // Populate dropdowns
  const yearsSet = new Set(allEvents.map(e => e.date.getFullYear()));
  const semestersSet = new Set(allEvents.map(e => e.semester));

  calendarYearSelect.innerHTML = `<option value="All">All</option>` + 
    Array.from(yearsSet).map(y => `<option value="${y}">${y}</option>`).join("");

  calendarSemesterSelect.innerHTML = `<option value="All">All</option>` + 
    Array.from(semestersSet).map(s => `<option value="${s}">${s}</option>`).join("");

  function renderCalendar() {
    const selectedYear = calendarYearSelect.value;
    const selectedSemester = calendarSemesterSelect.value;

    calendarGrid.innerHTML = '';
    monthTitle.textContent = `${months[currentMonth]} ${currentYear}`;

    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-row';
    weekdays.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell header';
      cell.textContent = day;
      headerRow.appendChild(cell);
    });
    calendarGrid.appendChild(headerRow);

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
    let row = document.createElement('div');
    row.className = 'calendar-row';

    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-cell empty';
      row.appendChild(emptyCell);
    }

    for (let d = 1; d <= lastDate; d++) {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell';
      cell.innerHTML = `<span class="date-number">${d}</span>`;

      // Add events
      allEvents.forEach(ev => {
        if (
          ev.date.getFullYear() === currentYear &&
          ev.date.getMonth() === currentMonth &&
          ev.date.getDate() === d &&
          (selectedYear === "All" || ev.date.getFullYear() == selectedYear) &&
          (selectedSemester === "All" || ev.semester === selectedSemester)
        ) {
                  const badge = document.createElement('span');
        badge.className = 'event-badge';
        badge.style.backgroundColor = eventColors[ev.type] || "#eee";
        badge.style.display = 'block';
        badge.style.fontSize = "0.7rem";
        badge.style.padding = "2px 4px";
        badge.style.borderRadius = "4px";
        badge.style.marginTop = "2px";

        // Truncate long text
        const maxLength = 12;
        badge.textContent = ev.name.length > maxLength ? ev.name.substring(0, maxLength) + "..." : ev.name;

        // Add click event to show full details
        badge.title = ev.name; // simple tooltip on hover
         badge.addEventListener('click', () => {
          document.getElementById("eventName").textContent = ev.name;
          document.getElementById("eventType").textContent = ev.type;
          document.getElementById("eventDate").textContent = ev.date.toDateString();
          modal.style.display = "flex";
      });
        cell.appendChild(badge);

        }
      });

      row.appendChild(cell);
      if ((d + firstDay) % 7 === 0 || d === lastDate) {
        calendarGrid.appendChild(row);
        row = document.createElement('div');
        row.className = 'calendar-row';
      }
    }
  }

  prevBtn.addEventListener('click', () => {
    currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    currentYear = currentMonth === 11 ? currentYear - 1 : currentYear;
    renderCalendar();
  });

  nextBtn.addEventListener('click', () => {
    currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
    currentYear = currentMonth === 0 ? currentYear + 1 : currentYear;
    renderCalendar();
  });

calendarYearSelect.addEventListener('change', () => {
    const selectedYear = calendarYearSelect.value;

    if (selectedYear !== "All") {
        // Find first month in that year that has events
        const eventsInYear = allEvents.filter(ev => ev.date.getFullYear() == selectedYear);
        if (eventsInYear.length > 0) {
            // Set currentMonth to the first month with an event
            currentMonth = eventsInYear[0].date.getMonth();
        } else {
            // If no events, default to January
            currentMonth = 0;
        }
        currentYear = parseInt(selectedYear);
    }

    renderCalendar();
});

  calendarSemesterSelect.addEventListener('change', renderCalendar);

  renderCalendar();

    const modal = document.getElementById("eventModal");
const closeBtn = modal.querySelector(".close");

// Close modal
closeBtn.addEventListener('click', () => modal.style.display = "none");
window.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = "none";
});

});

</Script>
{% endblock %}


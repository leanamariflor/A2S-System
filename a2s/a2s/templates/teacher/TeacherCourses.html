{% extends "teacher/teacher_base.html" %}
{% load static %}

{% block title %}Courses{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'teacher/css/teacher_courses.css' %}">
{% endblock %}

{% block content %}
<div class="course-dashboard">

  <!-- Header -->
  <div class="header-card">
    <h2>Courses</h2>
    <p id="schoolYear">Loading...</p>
    <span id="activeCourses">Loading...</span>
  </div>

  <div class="main-content">
    <!-- Left Section: My Enrolled Courses -->
    <div class="left-panel">
      <h3>My Enrolled Courses</h3>
      <table class="course-table" id="courseTable">
  <thead>
    <tr>
      <th>Course Code</th>
      <th>Section</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% if courses %}
      {% for course in courses %}
      <tr>
        <td><strong>{{ course.course_code }}</strong></td>
        <td>{{ course.section }}</td>
        <td>
          {% if course.action == "view" %}
            <button class="view-btn">View Roster</button>
          {% elif course.action == "upload" %}
            <button class="upload-btn">Upload Grades</button>
          {% else %}
            <button disabled>Unavailable</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="3">No courses assigned.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

    </div>

    <!-- Right Section: Management and Upload -->
    <div class="right-panel">
      <div class="section-management">
        <h4>Section Management</h4>
        <label>Select Course/Section</label>
        <select id="sectionSelect">
          <option>Loading...</option>
        </select>
        <div class="btn-group">
          <button class="add-course-btn">Add Course</button>
          <button class="view-sections-btn">View All Sections</button>
        </div>
      </div>

      <div class="student-progress">
        <h4>Student Progress Upload</h4>
        <p>Semestral Attendance & Scores</p>
        <button class="upload-file-btn">Upload Student Files</button>
        <small>Supported formats: .csv, .xlsx, .pdf</small>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const yearEl = document.querySelector("#schoolYear");
  const activeEl = document.querySelector("#activeCourses");
  const tbody = document.querySelector("#courseBody");
  const sectionSelect = document.querySelector("#sectionSelect");

  fetch("/api/teacher_courses/")
    .then(response => {
      if (!response.ok) throw new Error("Network response was not ok");
      return response.json();
    })
    .then(data => {
      // Header info
      yearEl.textContent = data.school_year || "N/A";
      activeEl.textContent = `${data.active_courses || 0} active courses`;

      // Build course table
      tbody.innerHTML = "";
      sectionSelect.innerHTML = '<option>Select Course/Section</option>';

      if (!data.courses || data.courses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No courses assigned.</td></tr>';
        return;
      }

      data.courses.forEach(course => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><strong>${course.course_code}</strong><br><small>${course.course_name}</small></td>
          <td>${course.meeting_days}<br>${course.section}</td>
          <td>${course.time || "-"}</td>
          <td>${course.room || "-"}</td>
          <td>
            ${
              course.action === "view"
                ? '<button class="view-btn">View Roster</button>'
                : course.action === "upload"
                ? '<button class="upload-btn">Upload Grades</button>'
                : '<button disabled>Unavailable</button>'
            }
          </td>
        `;
        tbody.appendChild(row);

        // Also add to dropdown
        const opt = document.createElement("option");
        opt.value = `${course.course_code}-${course.section}`;
        opt.textContent = `${course.course_code} - ${course.section}`;
        sectionSelect.appendChild(opt);
      });
    })
    .catch(err => {
      console.error("Error fetching teacher courses:", err);
      tbody.innerHTML = `<tr><td colspan="6" style="color:red;">Error loading data: ${err.message}</td></tr>`;
      yearEl.textContent = "N/A";
      activeEl.textContent = "0 active courses";
      sectionSelect.innerHTML = '<option>Error loading</option>';
    });
});
</script>
{% endblock %}

{% extends "faculty/teacher_base.html" %}
{% load static %}

{% block title %}A2S Teacher Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teacherDashboard.css' %}" />
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="welcome-card">
  <div class="welcome-content">
    <div class="welcome-text">
     <h2>Welcome back, Professor {{ last_name }}</h2>
      <p>{{ department }} â€¢ {{ current_semester }}</p>
    </div>
    <div class="welcome-gpa">
      <div class="gpa-value">317</div>
      <div class="gpa-label">Total Students</div>
    </div>
  </div>
</div>

<!-- Dashboard Tabs -->
<div class="tabs">
  <div class="tab-list">
    <button class="tab-trigger active" data-tab="overview">Overview</button>
    <button class="tab-trigger" data-tab="courses">My Courses</button>
    <button class="tab-trigger" data-tab="assignments">Assignments</button>
    <button class="tab-trigger" data-tab="grades">Grades</button>
    <button class="tab-trigger" data-tab="calendar">Academic Calendar</button>
    <button class="tab-trigger" data-tab="map">University Map</button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-content active" id="overview">
    <div class="quick-actions-grid">
      <div class="action-card"><i data-lucide="calendar"></i><h3>Schedule</h3><p>View timetable</p></div>
      <div class="action-card"><i data-lucide="line-chart"></i><h3>Student Progress</h3><p>Track performance</p></div>
      <div class="action-card"><i data-lucide="upload"></i><h3>Upload Grades</h3><p>Record assessments</p></div>
      <div class="action-card"><i data-lucide="file-bar-chart"></i><h3>Reports</h3></div>
      <div class="action-card"><i data-lucide="megaphone"></i><h3>Announcement</h3><p>Post updates</p></div>
    </div>

    <div class="cards-row">
      <!-- Current Courses Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Current Courses</div>
          <div class="card-description">2025-2026 â€¢ 8 enrolled courses</div>
        </div>
        <div class="card-content">
          <div class="course-list">
            <div class="course-item"><div class="course-details"><div class="course-code">IT317 - G5</div><div class="course-name">Project Management 1</div></div><div class="course-units">38 students</div></div>
            <div class="course-item"><div class="course-details"><div class="course-code">CSIT340 - G4</div><div class="course-name">Industry Elective 2</div></div><div class="course-units">40 students</div></div>
            <div class="course-item"><div class="course-details"><div class="course-code">CSIT340 - G4</div><div class="course-name"></div></div><div class="course-units"></div></div>
          </div>
        </div>
      </div>

      <!-- Recent Alerts Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Alerts</div>
          <div class="card-description">Student notifications requiring attention</div>
        </div>
        <div class="card-content">
          <div class="task-list">
            <div class="task-item"><div class="task-details"><div class="task-title">John Doe Junior BamBam</div><div class="task-due">GPA dropped below 2.0</div></div><div class="task-type">GPA!</div></div>
            <div class="task-item"><div class="task-details"><div class="task-title">Jackie Chenban</div><div class="task-due">Missing multiple classes</div></div><div class="task-type">Attendance</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Courses Tab -->
  <div class="tab-content" id="courses">
    <div class="card">
      <div class="card-header"><div class="card-title">My Courses</div><div class="card-description">Courses you are currently handling</div></div>
      <div class="card-content">
        <div class="course-list">
          <div class="course-item"><div class="course-details"><div class="course-code">IT317</div><div class="course-name">Systems Integration</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
          <div class="course-item"><div class="course-details"><div class="course-code">CSIT327</div><div class="course-name">Database Systems</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
          <div class="course-item"><div class="course-details"><div class="course-code">IT315</div><div class="course-name">Web Development</div><div class="course-instructor">Prof. Revilleza</div></div><div class="course-units">3 units</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="assignments">
    <div class="card">
      <div class="card-header"><div class="card-title">Assignments</div><div class="card-description">View and manage assignments</div></div>
      <div class="card-content"><p>Assignment management UI placeholder.</p></div>
    </div>
  </div>

  <div class="tab-content" id="grades">
    <div class="card">
      <div class="card-header"><div class="card-title">Grades</div><div class="card-description">Upload and manage student grades</div></div>
      <div class="card-content"><p>Grades management UI placeholder.</p></div>
    </div>
  </div>

<!-- Calendar Tab -->
<div class="tab-content" id="calendar">
  <div class="calendar-controls">
  <label for="calendarSemesterSelect">Semester:</label>
  <select id="calendarSemesterSelect"></select>

  <label for="calendarYearSelect">Year:</label>
  <select id="calendarYearSelect"></select>
</div>

  <div class="calendar-container">
    <h2 id="month-title"></h2>
    <div class="calendar-nav">
      <button id="prev-month">&lt; Prev</button>
      <button id="next-month">Next &gt;</button>
    </div>
    <div id="calendar-grid"></div>
  </div>
</div>

  

<script>
document.addEventListener("DOMContentLoaded", function () {
  lucide.createIcons(); // Initialize Lucide icons

  // -------------------- Tabs --------------------
  const tabTriggers = document.querySelectorAll('.tab-trigger');
  const tabContents = document.querySelectorAll('.tab-content');
  tabTriggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const target = trigger.dataset.tab;
      tabTriggers.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      trigger.classList.add('active');
      document.getElementById(target).classList.add('active');
    });
  });

 
  // -------------------- Calendar --------------------

  

  const calendarGrid = document.getElementById("calendar-grid");
  const monthTitle = document.getElementById("month-title");
  const prevBtn = document.getElementById("prev-month");
  const nextBtn = document.getElementById("next-month");
  const calendarYearSelect = document.getElementById("calendarYearSelect");
  const calendarSemesterSelect = document.getElementById("calendarSemesterSelect");

  let currentDate = new Date();
  let currentYear = currentDate.getFullYear();
  let currentMonth = currentDate.getMonth();
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  // -------------------- Load Calendar Data --------------------
  let calendarData = [];
try {
    calendarData = JSON.parse('{{ calendar_json|escapejs }}');  // parse JSON string
    if (!Array.isArray(calendarData)) {
        console.error("Calendar JSON is not an array:", calendarData);
        calendarData = [];
    }
} catch (e) {
    console.error("Error parsing calendar JSON:", e);
}
console.log("calendarData:", calendarData);  // debug

  if (!Array.isArray(calendarData)) {
    console.error("Calendar data is not an array:", calendarData);
    calendarData = [];
  }

  // Flatten events
  let allEvents = [];
  calendarData.forEach(sem => {
    sem.events.forEach(ev => {
      allEvents.push({
        date: new Date(ev.date),
        name: ev.name,
        type: ev.type,
        semester: sem.semester
      });
    });
  });

  const eventColors = {
    "Holiday": "#ffcccc",
    "Class Start": "#cce5ff",
    "Class End": "#d4edda",
    "Exam": "#fff3cd",
    "Deadline": "#f8d7da",
    "Ceremony": "#e2e3e5",
    "Special Non-Working Day": "#f0b3ff"
  };

  // Populate dropdowns
  const yearsSet = new Set(allEvents.map(e => e.date.getFullYear()));
  const semestersSet = new Set(allEvents.map(e => e.semester));

  calendarYearSelect.innerHTML = `<option value="All">All</option>` + 
    Array.from(yearsSet).map(y => `<option value="${y}">${y}</option>`).join("");

  calendarSemesterSelect.innerHTML = `<option value="All">All</option>` + 
    Array.from(semestersSet).map(s => `<option value="${s}">${s}</option>`).join("");

  function renderCalendar() {
    const selectedYear = calendarYearSelect.value;
    const selectedSemester = calendarSemesterSelect.value;

    calendarGrid.innerHTML = '';
    monthTitle.textContent = `${months[currentMonth]} ${currentYear}`;

    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-row';
    weekdays.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell header';
      cell.textContent = day;
      headerRow.appendChild(cell);
    });
    calendarGrid.appendChild(headerRow);

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
    let row = document.createElement('div');
    row.className = 'calendar-row';

    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-cell empty';
      row.appendChild(emptyCell);
    }

      for (let d = 1; d <= lastDate; d++) {
      const cell = document.createElement('div');
      cell.className = 'calendar-cell';
      cell.innerHTML = `<span class="date-number">${d}</span>`;

      // ðŸ”¹ Highlight today's date
      const today = new Date();
      if (
        d === today.getDate() &&
        currentMonth === today.getMonth() &&
        currentYear === today.getFullYear()
      ) {
        cell.classList.add('today');
      }

      // Add events
      allEvents.forEach(ev => {
        if (
          ev.date.getFullYear() === currentYear &&
          ev.date.getMonth() === currentMonth &&
          ev.date.getDate() === d &&
          (selectedYear === "All" || ev.date.getFullYear() == selectedYear) &&
          (selectedSemester === "All" || ev.semester === selectedSemester)
        ) {
                  const badge = document.createElement('span');
        badge.className = 'event-badge';
        badge.style.backgroundColor = eventColors[ev.type] || "#eee";
        badge.style.display = 'block';
        badge.style.fontSize = "0.7rem";
        badge.style.padding = "2px 4px";
        badge.style.borderRadius = "4px";
        badge.style.marginTop = "2px";

        // Truncate long text
        const maxLength = 12;
        badge.textContent = ev.name.length > maxLength ? ev.name.substring(0, maxLength) + "..." : ev.name;

        // Add click event to show full details
        badge.title = ev.name; // simple tooltip on hover
         badge.addEventListener('click', () => {
          document.getElementById("eventName").textContent = ev.name;
          document.getElementById("eventType").textContent = ev.type;
          document.getElementById("eventDate").textContent = ev.date.toDateString();
          modal.style.display = "flex";
      });
        cell.appendChild(badge);

        }
      });

      row.appendChild(cell);
      if ((d + firstDay) % 7 === 0 || d === lastDate) {
        calendarGrid.appendChild(row);
        row = document.createElement('div');
        row.className = 'calendar-row';
      }
    }
  }

  prevBtn.addEventListener('click', () => {
    currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    currentYear = currentMonth === 11 ? currentYear - 1 : currentYear;
    renderCalendar();
  });

  nextBtn.addEventListener('click', () => {
    currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
    currentYear = currentMonth === 0 ? currentYear + 1 : currentYear;
    renderCalendar();
  });

calendarYearSelect.addEventListener('change', () => {
    const selectedYear = calendarYearSelect.value;

    if (selectedYear !== "All") {
        // Find first month in that year that has events
        const eventsInYear = allEvents.filter(ev => ev.date.getFullYear() == selectedYear);
        if (eventsInYear.length > 0) {
            // Set currentMonth to the first month with an event
            currentMonth = eventsInYear[0].date.getMonth();
        } else {
            // If no events, default to January
            currentMonth = 0;
        }
        currentYear = parseInt(selectedYear);
    }

    renderCalendar();
});

  calendarSemesterSelect.addEventListener('change', renderCalendar);

  renderCalendar();

    const modal = document.getElementById("eventModal");
const closeBtn = modal.querySelector(".close");

// Close modal
closeBtn.addEventListener('click', () => modal.style.display = "none");
window.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = "none";
});

});

</Script>
{% endblock %}

{% extends "student_base.html" %}
{% load static %}

{% block title %}Student Profile - A2S{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/student_profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-page-container">

    <!-- Header with Edit Profile Button -->
    <div class="header-info" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>Student Profile</h1>
            <p>Manage your account information</p>
        </div>
        <button id="edit-profile-button" class="edit-profile-button">
            <i data-lucide="edit"></i> Edit Profile
        </button>
    </div>

    <div id="profile-container" class="read-only">

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-list">
                <button class="tab-trigger active" data-tab="personal">Personal Info</button>
                <button class="tab-trigger" data-tab="academic">Academic Info</button>
                <button class="tab-trigger" data-tab="achievements">Achievements</button>
            </div>

            <!-- Personal Info -->
            <div class="tab-content active" id="personal">
                <div class="profile-grid">

                    <!-- Profile Picture Card -->
                    <div class="profile-picture-card">
                        <div class="profile-picture-wrapper">
                            <div class="profile-picture"><i data-lucide="user"></i></div>
                            <div class="editable-field">
                                <input type="file" name="profile_picture">
                            </div>
                        </div>
                        <h2 class="profile-name" data-field="full_name">{{ first_name }} {{ last_name }}</h2>
                        <div class="profile-badge" data-field="year_major">{{ academic_year }} • {{ major }}</div>
                    </div>

                    <!-- Contact Information -->
                    <div class="contact-card">
                        <h3 class="card-title"><i data-lucide="mail"></i> Contact Information</h3>

                        <div class="form-field">
                            <label>First Name</label>
                            <p class="field-value" data-field="first_name">{{ first_name }}</p>
                            <div class="editable-field">
                                <input type="text" name="first_name" value="{{ first_name }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Last Name</label>
                            <p class="field-value" data-field="last_name">{{ last_name }}</p>
                            <div class="editable-field">
                                <input type="text" name="last_name" value="{{ last_name }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Email</label>
                            <p class="field-value" data-field="email">{{ email }}</p>
                            <div class="editable-field">
                                <input type="email" name="email" value="{{ email }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Phone Number</label>
                            <p class="field-value" data-field="phone">{{ phone|default:'' }}</p>
                            <div class="editable-field">
                                <input type="text" name="phone" value="{{ phone }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Address</label>
                            <p class="field-value" data-field="address">{{ address|default:'' }}</p>
                            <div class="editable-field">
                                <input type="text" name="address" value="{{ address }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Date of Birth</label>
                            <p class="field-value" data-field="dob">{{ dob_display }}</p>
                            <div class="editable-field">
                                <input type="date" name="dob" value="{{ dob|date:'Y-m-d' }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Bio</label>
                            <p class="field-value" data-field="bio">{{ bio|default:'' }}</p>
                            <div class="editable-field">
                                <textarea name="bio">{{ bio }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Academic Info -->
            <div class="tab-content" id="academic">
                <div class="academic-grid">
                    <div class="card">
                        <h3 class="card-title"><i data-lucide="graduation-cap"></i> Academic Details</h3>

                        <div class="form-field">
                            <label>Student ID</label>
                            <p class="field-value" data-field="student_id">{{ student_id|default:'' }}</p>
                            <div class="editable-field">
                                <input type="text" name="student_id" value="{{ student_id }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Major</label>
                            <p class="field-value" data-field="major">{{ major }}</p>
                            <div class="editable-field">
                                <input type="text" name="major" value="{{ major }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Academic Year</label>
                            <p class="field-value" data-field="academic_year">{{ academic_year|default:'' }}</p>
                            <div class="editable-field">
                                <input type="number" name="academic_year" value="{{ academic_year }}" min="1" max="5">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Expected Graduation</label>
                            <p class="field-value" data-field="expected_graduation">{{ expected_graduation_display }}</p>
                            <div class="editable-field">
                                <input type="date" name="expected_graduation" value="{{ expected_graduation|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title"><i data-lucide="book-open"></i> Academic Progress</h3>

                        <div class="form-field">
                            <label>Current GPA</label>
                            <div class="gpa-display">
                                <span class="gpa-value" data-field="gpa">{{ gpa|default:'' }}</span>
                                <span class="gpa-max">/ 4.0</span>
                            </div>
                            <div class="editable-field">
                                <input type="number" step="0.01" name="gpa" value="{{ gpa }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Credits Completed</label>
                            <div class="credits-display">
                                <span class="credits-value" data-field="credits_completed">{{ credits_completed|default:'' }}</span>
                                <span class="credits-max">/ {{ credits_required|default:'' }}</span>
                            </div>
                            <div class="editable-field">
                                <input type="number" name="credits_completed" value="{{ credits_completed }}">
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Academic Standing</label>
                            <div class="status-badge success" data-field="academic_standing">{{ academic_standing|default:'Good Standing' }}</div>
                            <div class="editable-field">
                                <input type="text" name="academic_standing" value="{{ academic_standing }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="tab-content" id="achievements">
                <div class="card">
                    <h3 class="card-title"><i data-lucide="award"></i> Academic Achievements</h3>
                    <div class="achievements-grid" id="achievements-container">
                        {% for achievement in achievements %}
                        <div class="achievement-card" data-field="achievement_{{ forloop.counter }}">
                            <i data-lucide="{{ achievement.icon }}"></i>
                            <h4>{{ achievement.title }}</h4>
                            <div class="editable-field">
                                <input type="text" name="achievement_{{ forloop.counter }}_title" value="{{ achievement.title }}">
                                <input type="text" name="achievement_{{ forloop.counter }}_description" value="{{ achievement.description }}">
                            </div>
                            <p>{{ achievement.description }}</p>
                        </div>
                        {% empty %}
                        <p>No achievements yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div> <!-- end tabs -->
    </div> <!-- end profile-container -->

    <!-- Instead of just Save button -->
    <div class="profile-actions" style="display: none;" id="profile-actions">
        <button id="save-profile-button" class="save-button">Save Changes</button>
        <button id="cancel-profile-button" class="cancel-button">Cancel</button>
    </div>


</div>

<script>
lucide.createIcons();

// Tabs
document.querySelectorAll('.tab-trigger').forEach(trigger => {
    trigger.addEventListener('click', () => {
        const targetTab = trigger.getAttribute('data-tab');
        document.querySelectorAll('.tab-trigger').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        trigger.classList.add('active');
        document.getElementById(targetTab).classList.add('active');
    });
});
const cancelButton = document.getElementById('cancel-profile-button');
cancelButton.addEventListener('click', () => {
    profileContainer.classList.remove('edit-mode');
    profileContainer.classList.add('read-only');

    // hide buttons
    document.getElementById('profile-actions').style.display = 'none';

    // Reset form fields to original values
    document.querySelectorAll('.editable-field input, .editable-field textarea').forEach(input => {
        const fieldName = input.name;
        const displayEl = document.querySelector(`.field-value[data-field="${fieldName}"]`);
        if(displayEl) input.value = displayEl.textContent;
    });
});


// Edit Mode Toggle
const editButton = document.getElementById('edit-profile-button');
const profileContainer = document.getElementById('profile-container');
const saveButton = document.getElementById('save-profile-button');

editButton.addEventListener('click', () => {
    profileContainer.classList.toggle('edit-mode');
    profileContainer.classList.toggle('read-only');

    const inEditMode = profileContainer.classList.contains('edit-mode');
    const actions = document.getElementById('profile-actions');
    if(actions) actions.style.display = inEditMode ? 'flex' : 'none';
});

saveButton.addEventListener('click', () => {
    const formData = {};
    
    document.querySelectorAll('#profile-container .editable-field input, #profile-container .editable-field textarea')
        .forEach(input => {
            let value = input.value;
            if (['credits_completed','credits_required','academic_year'].includes(input.name)) value = parseInt(value) || 0;
            if (input.name === 'gpa') value = parseFloat(value) || 0;
            formData[input.name] = value;
        });

    fetch("{% url 'UpdateStudentProfile' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(formData)
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            // Update profile card fields
            for(const key in formData){
                const display = document.querySelector(`.field-value[data-field="${key}"]`);
                if(display) display.textContent = formData[key];
                
            }
            // Update top profile card
            const fullNameEl = document.querySelector('[data-field="full_name"]');
            if(fullNameEl) fullNameEl.textContent = `${formData.first_name} ${formData.last_name}`;

            const badgeEl = document.querySelector('[data-field="year_major"]');
            if(badgeEl) badgeEl.textContent = `${formatYear(parseInt(formData.academic_year)||1)} • ${formData.major}`;



            // Update sidebar dynamically
            const sidebarName = document.getElementById('student-name');
            if(sidebarName) sidebarName.textContent = `${formData.first_name} ${formData.last_name}`;

            const sidebarProgram = document.getElementById('student-program');
            if(sidebarProgram) sidebarProgram.textContent = formData.major || formData.program;

            const sidebarYear = document.getElementById('student-year');
            if(sidebarYear) sidebarYear.textContent = getYearSuffix(parseInt(formData.academic_year) || 1);

            // Back to read-only mode
            profileContainer.classList.remove('edit-mode');
            profileContainer.classList.add('read-only');
            saveButton.style.display = 'none';

            alert("Profile updated successfully!");
        } else {
            alert("Error updating profile: " + (data.message || "Unknown error"));
        }
    })
    .catch(err => {
        console.error(err);
        alert("An error occurred while updating the profile.");
    });
});

// Academic Year formatter
function formatYear(year){
    if(year<=1) return "1st Year";
    if(year===2) return "2nd Year";
    if(year===3) return "3rd Year";
    if(year===4) return "4th Year";
    if(year>=5) return "5th Year";
    return year+"th Year";
}

// Instant update while typing
document.querySelectorAll('.editable-field input, .editable-field textarea').forEach(input=>{
    input.addEventListener('input', ()=>{
        const el = document.querySelector(`.field-value[data-field="${input.name}"]`);
        if(el) el.textContent = input.value;
    });
});
</script>

{% endblock %}
